define(["exports"],(function(e){"use strict";const t="Trimble.dispatcher.v1",n={},o={};let r=1;function i(e){const t=p();return o[t]=e,()=>delete o[t]}function s(e,o,r,i,s=1e4){return new Promise(((c,a)=>{const u=p(),f={scope:t,type:"request",id:u,api:r,args:i};let d;s>0&&(d=setTimeout((()=>{delete n[u],a(new Error("dispatcher.ts | sendRequest(): Operation timed out."))}),s)),n[u]=e=>{delete n[u],d&&clearTimeout(d),e.error?a(e.error):c(e.result)},e.postMessage(f,o)}))}function c(e,n,o,r){const i={scope:t,type:"event",event:o,data:r};e.postMessage(i,n)}async function a(e){const r=e.source,i="null"===e.origin?"*":e.origin,s=e.data;if(function(e){return u(e)&&"event"===e.type}(s))for(const e in o){if(!o.hasOwnProperty(e))continue;const t=o[e].event;t&&t(r,i,s.event,s.data)}else if(function(e){return u(e)&&"request"===e.type}(s)){let e;for(const n in o){if(!o.hasOwnProperty(n))continue;const c=o[n].request;if(c&&!e){const n=c(r,i,s.api,s.args);if(void 0!==n)try{e={scope:t,type:"response",id:s.id,api:s.api,result:await n}}catch(n){e={scope:t,type:"response",id:s.id,api:s.api,error:String(n)}}}}e||(e={scope:t,type:"response",id:s.id,api:s.api,error:"Not supported"}),r.postMessage(e,i)}else if(function(e){return u(e)&&"response"===e.type}(s)){const e=n[s.id];e&&e(s)}}function u(e){return!!e&&e.scope===t}function p(){return r++}const f=".connect_api_client_v1",d=".api_function_v1",l={},w=[];let g;const y=new Promise((e=>{g=()=>{g=()=>{},e()}}));let v;function m(e){if("object"!=typeof e)throw new Error("Api must be an object");b(l,e),g()}function h(e,t){return"function"==typeof e&&"function"==typeof t&&e.name===t.name||("string"==typeof e&&"string"==typeof t||"number"==typeof e&&"number"==typeof t)}function b(e,t){for(const n in t){const o=t[n];if(o)if(n in e){const t=e[n];if("object"==typeof o&&"object"==typeof t)b(t,o);else{if(!h(o,t))throw new Error(`Cannot merge ${n} (${t} and ${o})`);e[n]=o}}else switch(typeof o){case"object":{const t={};b(t,o),e[n]=t;break}default:e[n]=o}}}function S(e,t,n){const o={};for(const r in e){const i=e[r];if((void 0!==n||"onConnect"!==r&&"onRequest"!==r)&&i)if("object"==typeof i){const e=n&&n+"."+String(r)||String(r);o[r]=S(i,t,e)}else o[r]=t(r,e[r],n)}return o}var M,E;i({request:(e,t,n,o)=>{if(n===f)return y.then((()=>{let n=w.find((t=>t.dispatcher===e));if(n)n.origin=t;else{if(!e)return;n={dispatcher:e,origin:t},w.push(n)}var o;return(o=l)&&"function"==typeof o.onConnect&&l.onConnect(n),S(l,((e,t)=>"function"==typeof t?d:t))}));{const i=w.find((n=>n.dispatcher===e&&n.origin===t));if(i){if((r=l)&&"function"==typeof r.onRequest){const e=l.onRequest(i,n,o);if(void 0!==e)return e}const e=function(e,t){const n=t.split(".");let o=e;for(const e of n)o="object"==typeof o&&o&&e in o?o[e]:void 0;return o}(l,n);if("function"==typeof e){const t=e.apply(void 0,o);return void 0===t?Promise.resolve(t):t}return Promise.resolve(e)}return}var r}}),e.PropertyType=void 0,(M=e.PropertyType||(e.PropertyType={}))[M.LengthMeasure=0]="LengthMeasure",M[M.AreaMeasure=1]="AreaMeasure",M[M.VolumeMeasure=2]="VolumeMeasure",M[M.MassMeasure=3]="MassMeasure",M[M.AngleMeasure=4]="AngleMeasure",M[M.StringValue=5]="StringValue",M[M.IntValue=6]="IntValue",M[M.DoubleValue=7]="DoubleValue",M[M.DateTime=8]="DateTime",M[M.Logical=9]="Logical",M[M.Boolean=10]="Boolean",e.ViewEntityStates=void 0,(E=e.ViewEntityStates||(e.ViewEntityStates={}))[E.Selected=1]="Selected",E[E.Hidden=4]="Hidden",E[E.SelectedHidden=5]="SelectedHidden",E[E.Visible=6]="Visible",E[E.SelectedVisible=7]="SelectedVisible",E[E.Highlighted=8]="Highlighted";var P;function O(e){return a(e)}e.SortDirection=void 0,(P=e.SortDirection||(e.SortDirection={}))[P.SORT_NONE=0]="SORT_NONE",P[P.SORT_UP=1]="SORT_UP",P[P.SORT_DOWN=-1]="SORT_DOWN",e.TOOLS=["reset","selection","areaSelection","measurement","pointMarkup","cloudMarkup","arrowMarkup","lineMarkup","textMarkup","freelineMarkup","clipPlane","verticalClipPlane","picking"],e.TOOL_SNAP_TYPES=["edge","point","surface"],e.connect=function(e,t,n){return window.removeEventListener("message",O),window.addEventListener("message",O),v&&v(),function(e,t,n=1e4){async function o(e,t){const o=await s(e,t,f,[],0);if(o&&"object"==typeof o)return S(o,((o,r,i)=>{if(r===d){const r=i?i+"."+String(o):String(o);return(...o)=>s(e,t,r,o,n)}return r}));throw new Error("Failed to connect")}function r(e){if(!e)return"*";try{return new URL(e).origin}catch(e){return"*"}}if(t&&(v=i({event:(e,n,o,r)=>t(o,r)})),e===window)return 0!==Object.keys(l).length?Promise.resolve(l):function(){const e=window;return e&&"CefSharp"in e}()?new Promise((async e=>{await CefSharp.BindObjectAsync("connectWsApiIntegrator");const t={postMessage:(e,t)=>{const n=JSON.stringify(e);connectWsApiIntegrator.postMessage(n)}};e(await o(t,"*"))})):function(){const e=window;return e&&e.chrome&&e.chrome.webview}()?o({postMessage:(e,t)=>{window.chrome.webview.postMessage(e)}},"*"):Promise.resolve(l);if((c=e)&&"function"==typeof c.postMessage)return o(e,"*");if(function(e){return e&&"object"==typeof e.contentWindow}(e)){const t=[];return t.push(new Promise(((t,n)=>{const i=async()=>{e.removeEventListener("load",i),e.contentWindow?t(await o(e.contentWindow,r(e.src))):n(new Error("Cannot access the target content window"))};e.addEventListener("load",i)}))),e.contentWindow&&t.push(o(e.contentWindow,r(e.src))),Promise.race(t)}return Promise.reject(new Error("Target must be a window or an iframe"));var c}(e,t,n)},e.dispatcherEventListener=O,e.expose=function(e){return m(e)},e.getConnectEmbedUrl=function(e="prod"){return`https://${{int:"web.int",qa:"web.qa",stage:"web.stage",prod:"web"}[e]}.connect.trimble.com?isEmbedded=true`},e.isApplicationEmbedded=function(){try{return window.self!==window.top}catch(e){return!0}},e.preregister=function(e){const t=w.find((t=>t.dispatcher===e.dispatcher));return t?(t.identifier=e.identifier||t.identifier,t.origin=e.origin||t.origin,t):e.dispatcher?(w.push(e),e):void 0},e.removeClient=function(e){const t=w.findIndex((t=>t.dispatcher===e.dispatcher));-1!==t&&w.splice(t,1)},e.sendEvent=function(e,t,n,o){c(e,t,n,o)},e.sendEventToAllClients=function(e,t={},n){for(const o of w)!o.origin||n&&o!==n||c(o.dispatcher,o.origin,e,t)},Object.defineProperty(e,"__esModule",{value:!0})}));
